<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TransitLK Beta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');

        :root {
            --app-bg: #000000;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-primary: #96d46c; /* TransitLK Green */
            --accent-glow: rgba(150, 212, 108, 0.3);
            --text-color: #ffffff;
        }

        .dashboard-night {
            --accent-primary: #f97316;
            --accent-glow: rgba(249, 115, 22, 0.5);
            --glass-border: rgba(249, 115, 22, 0.2);
        }

        * {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
            background-color: var(--app-bg);
            color: var(--text-color);
            height: 100dvh; 
            width: 100vw;
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 32px;
        }

        .btn-flex {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .btn-hollow {
            background: transparent;
            border: 1.5px solid var(--glass-border);
            color: var(--text-color);
        }
        .btn-hollow-accent {
            background: transparent;
            border: 1.5px solid var(--accent-primary);
            color: var(--accent-primary);
        }
        .btn-hollow-red {
            background: transparent;
            border: 1.5px solid #ef4444;
            color: #ef4444;
            opacity: 0.7;
        }

        .dynamic-accent-text { color: var(--accent-primary); }
        .dynamic-accent-bg { background-color: var(--accent-primary); }
        
        .dash-val {
            text-shadow: 0 0 20px var(--accent-glow);
            letter-spacing: -0.05em;
        }

        #splash-screen {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-out;
        }

        .logo-img-splash {
            max-width: auto;
            height: 180px;
        }

        .logo-img-header {
            height: 50px;
            width: auto;
        }

        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 160px;
            scrollbar-width: none;
        }
        .content-scroll::-webkit-scrollbar { display: none; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .is-tracking .hide-on-trip { display: none !important; }
        .is-tracking .show-on-trip { display: flex !important; }
        .show-on-trip { display: none; }

        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        #map {
            height: 280px;
            width: 100%;
            border-radius: 24px;
        }
    </style>
</head>
<body class="flex flex-col" id="app-body">

    <!-- SPLASH SCREEN -->
    <div id="splash-screen">
        <img src="logo.png" alt="Logo" class="logo-img-splash">
    </div>

    <!-- Layout Wrapper -->
    <div class="flex-1 flex flex-col px-6 pt-4 safe-top max-w-lg mx-auto w-full overflow-hidden">
        
        <!-- HEADER -->
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center">
                <img src="logo2.png" alt="Logo" class="logo-img-header">
            </div>
            
            <div class="flex gap-2 hide-on-trip">
                <button onclick="requestPermissions()" id="sensor-btn" class="glass h-10 px-4 btn-flex text-[10px] font-black uppercase tracking-widest dynamic-accent-text">
                    CONNECT
                </button>
            </div>

            <!-- Dashboard Clock (Visible only during trip) -->
            <div class="show-on-trip flex flex-col items-end">
                <p id="live-time" class="text-lg font-black tracking-tighter leading-none dynamic-accent-text">00:00:00</p>
                <p id="live-date" class="text-[9px] font-bold opacity-40 uppercase tracking-widest">Jan 01, 2024</p>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="glass p-1.5 flex gap-1 mb-6 hide-on-trip">
            <button onclick="switchTab('tracker')" id="btn-tracker" class="flex-1 py-3 rounded-[22px] font-black text-xs uppercase tracking-widest bg-white/10 dynamic-accent-text btn-flex">Tracker</button>
            <button onclick="switchTab('trips')" id="btn-trips" class="flex-1 py-3 rounded-[22px] font-black text-xs uppercase tracking-widest opacity-30 btn-flex">Trips</button>
        </div>

        <div class="content-scroll">
            <!-- TRACKER TAB -->
            <div id="tab-tracker" class="tab-content active space-y-6">
                
                <!-- ACTIVE TRIP MODE (Driver Dashboard) -->
                <div class="show-on-trip flex flex-col space-y-8">
                    <div class="text-center py-6">
                        <p class="text-8xl font-black tracking-tighter dash-val dynamic-accent-text leading-none" id="speed-trip">0.0</p>
                        <p class="text-[12px] font-black opacity-30 uppercase tracking-[0.4em] mt-4 text-center">Kilometers Per Hour</p>
                    </div>

                    <div class="glass p-6 space-y-6">
                        <div class="flex justify-between items-center">
                            <div class="space-y-1 w-full text-center">
                                <p class="text-[10px] font-black opacity-30 uppercase tracking-widest">Current Coordinates</p>
                                <p id="coords-trip" class="font-mono text-sm font-bold tracking-tight">--° --' --" N, --° --' --" E</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 border-t border-white/5 pt-6">
                            <div class="text-center border-r border-white/5">
                                <p class="text-[10px] font-black opacity-30 uppercase tracking-widest">Altitude</p>
                                <p class="text-xl font-black"><span id="alt-trip">0</span> <span class="text-[10px] opacity-40">m</span></p>
                            </div>
                            <div class="text-center">
                                <p class="text-[10px] font-black opacity-30 uppercase tracking-widest">Direction</p>
                                <p id="dir-trip" class="text-xl font-black dynamic-accent-text uppercase">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STANDBY MODE -->
                <div class="hide-on-trip space-y-6">
                    <div class="glass p-6">
                        <div class="flex justify-between items-center mb-8">
                            <span class="text-[10px] font-black uppercase tracking-widest dynamic-accent-text">Telemetry Engine</span>
                            <div id="gps-status" class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_#ef4444]"></div>
                        </div>
                        <div class="flex items-end justify-between mb-8">
                            <div>
                                <p class="text-6xl font-black tracking-tighter" id="speed">0.0</p>
                                <p class="text-[10px] font-black opacity-30 uppercase tracking-widest">Speed</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-black" id="heading-text">--</p>
                                <p class="text-[10px] font-black opacity-30 uppercase tracking-widest">Heading</p>
                            </div>
                        </div>
                        <div class="space-y-4 border-t border-white/5 pt-6">
                            <div class="flex justify-between font-mono text-sm">
                                <span class="opacity-40 uppercase">Lat</span> <span id="lat-dms">--° --' --"</span>
                            </div>
                            <div class="flex justify-between font-mono text-sm">
                                <span class="opacity-40 uppercase">Lng</span> <span id="lng-dms">--° --' --"</span>
                            </div>
                        </div>
                        <div class="mt-4 p-3 rounded-2xl bg-white/5 border border-white/5 text-center btn-flex">
                            <p id="overall-direction" class="text-[11px] font-black dynamic-accent-text uppercase tracking-wider">Awaiting movement...</p>
                        </div>
                    </div>

                    <div class="glass p-6">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-[10px] font-black uppercase tracking-widest opacity-30">Calibration</span>
                            <button onclick="calibrateSensors()" class="btn-hollow px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest active:bg-white/10 btn-flex">Calibrate</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-xs font-mono opacity-50">
                            <div class="text-center">ACCEL X: <span id="accel-x">0.00</span></div>
                            <div class="text-center">GYRO R: <span id="gyro-r">0.0</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TRIPS TAB -->
            <div id="tab-trips" class="tab-content space-y-4">
                <div id="trip-list" class="space-y-4"></div>
            </div>
        </div>

        <!-- Sticky Bottom Controls -->
        <div class="fixed bottom-0 left-0 right-0 p-8 safe-bottom pointer-events-none">
            <div class="max-w-md mx-auto pointer-events-auto flex flex-col gap-3">
                <button id="start-btn" onclick="startTrip()" class="hide-on-trip w-full py-6 dynamic-accent-bg text-black rounded-[28px] font-black uppercase tracking-[0.3em] shadow-2xl active:scale-[0.96] btn-flex">
                    Start Tracking
                </button>
                <button id="stop-btn" onclick="stopTrip()" class="show-on-trip w-full py-5 btn-hollow-accent rounded-[24px] font-black uppercase tracking-[0.2em] active:bg-white/5 hidden btn-flex">
                    Finish Trip
                </button>
                <button id="emergency-btn" class="show-on-trip w-full py-5 btn-hollow-red rounded-[24px] font-black uppercase tracking-[0.2em] active:bg-red-500/10 hidden btn-flex">
                    Report Emergency
                </button>
            </div>
        </div>

        <!-- Modal -->
        <div id="trip-modal" class="fixed inset-0 z-[100] bg-black hidden flex flex-col p-6 safe-top safe-bottom">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-xs font-black uppercase tracking-widest dynamic-accent-text">Trip Telemetry</h2>
                <button onclick="closeModal()" class="w-12 h-12 glass btn-flex rounded-2xl"><i data-lucide="x"></i></button>
            </div>
            <div class="flex-1 flex flex-col gap-6 overflow-hidden">
                <div id="map" class="border border-white/10"></div>
                <div class="flex gap-3">
                    <button onclick="downloadCSV()" class="flex-1 glass py-5 text-xs font-black uppercase tracking-widest dynamic-accent-text btn-flex">Export CSV</button>
                    <button onclick="deleteTrip()" class="w-16 glass py-5 btn-flex text-red-500"><i data-lucide="trash-2" size="18"></i></button>
                </div>
                <div class="flex-1 glass p-5 overflow-auto">
                    <pre id="csv-preview" class="text-[10px] font-mono opacity-50"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let isRecording = false;
        let tripData = [];
        let tripsHistory = JSON.parse(localStorage.getItem('transitlk_trips') || '[]');
        let startPoint = null, currentPoint = null, activeTripId = null;
        let offsets = { accel: { x: 0, y: 0, z: 0 }, gyro: { alpha: 0, beta: 0, gamma: 0 } };
        let rawSensors = { accel: { x: 0, y: 0, z: 0 }, gyro: { alpha: 0, beta: 0, gamma: 0 } };

        setInterval(() => {
            const now = new Date();
            const liveTime = document.getElementById('live-time');
            const liveDate = document.getElementById('live-date');
            if (liveTime) liveTime.innerText = now.toLocaleTimeString('en-US', { hour12: false });
            if (liveDate) liveDate.innerText = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }, 1000);

        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                if (splash) {
                    splash.style.opacity = '0';
                    setTimeout(() => splash.style.display = 'none', 800);
                }
            }, 2500);
            updateTripList();
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            const targetTab = document.getElementById('tab-' + tab);
            if (targetTab) targetTab.classList.add('active');
            
            const btns = ['btn-tracker', 'btn-trips'];
            btns.forEach(b => {
                const el = document.getElementById(b);
                if (el) {
                    if (b === 'btn-' + tab) {
                        el.classList.add('bg-white/10', 'dynamic-accent-text');
                        el.style.opacity = "1";
                    } else {
                        el.classList.remove('bg-white/10', 'dynamic-accent-text');
                        el.style.opacity = "0.3";
                    }
                }
            });
            if (tab === 'trips') updateTripList();
        }

        function toDMS(decimal, isLat) {
            const absolute = Math.abs(decimal);
            const degrees = Math.floor(absolute);
            const minutes = Math.floor((absolute - degrees) * 60);
            const seconds = (((absolute - degrees) * 60 - minutes) * 60).toFixed(6);
            const dir = isLat ? (decimal >= 0 ? "N" : "S") : (decimal >= 0 ? "E" : "W");
            return `${degrees}° ${minutes}' ${seconds}" ${dir}`;
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180;
            const Δλ = (lon2 - lon1) * Math.PI/180;
            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            let θ = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
            const dirs = ['North', 'N-East', 'East', 'S-East', 'South', 'S-West', 'West', 'N-West'];
            return dirs[Math.round(θ / 45) % 8];
        }

        async function requestPermissions() {
            try {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') await DeviceOrientationEvent.requestPermission();
                window.addEventListener('devicemotion', (e) => {
                    rawSensors.accel = { x: e.acceleration.x || 0, y: e.acceleration.y || 0, z: e.acceleration.z || 0 };
                    const el = document.getElementById('accel-x');
                    if (el) el.innerText = (rawSensors.accel.x - offsets.accel.x).toFixed(2);
                });
                window.addEventListener('deviceorientation', (e) => {
                    rawSensors.gyro = { alpha: e.alpha || 0, beta: e.beta || 0, gamma: e.gamma || 0 };
                    const el = document.getElementById('gyro-r');
                    if (el) el.innerText = (rawSensors.gyro.alpha - offsets.gyro.alpha).toFixed(1);
                });
                startGPSTracking();
                const btn = document.getElementById('sensor-btn');
                if (btn) {
                    btn.innerText = 'CONNECTED';
                    btn.classList.add('bg-[#96d46c]/10');
                }
            } catch (e) { console.error(e); }
        }

        function startGPSTracking() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition((pos) => {
                    const { latitude, longitude, speed, heading, altitude } = pos.coords;
                    currentPoint = { lat: latitude, lng: longitude };
                    
                    const dmsLat = toDMS(latitude, true);
                    const dmsLng = toDMS(longitude, false);
                    const spdKmh = ((speed || 0) * 3.6).toFixed(1);
                    const altVal = altitude ? altitude.toFixed(0) : 0;

                    const statusEl = document.getElementById('gps-status');
                    if (statusEl) statusEl.className = 'w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]';
                    
                    const latEl = document.getElementById('lat-dms');
                    if (latEl) latEl.innerText = dmsLat;
                    
                    const lngEl = document.getElementById('lng-dms');
                    if (lngEl) lngEl.innerText = dmsLng;
                    
                    const spdEl = document.getElementById('speed');
                    if (spdEl) spdEl.innerText = spdKmh;
                    
                    const spdTripEl = document.getElementById('speed-trip');
                    if (spdTripEl) spdTripEl.innerText = spdKmh;
                    
                    const coordsTripEl = document.getElementById('coords-trip');
                    if (coordsTripEl) coordsTripEl.innerText = `${dmsLat}, ${dmsLng}`;
                    
                    const altTripEl = document.getElementById('alt-trip');
                    if (altTripEl) altTripEl.innerText = altVal;
                    
                    const headEl = document.getElementById('heading-text');
                    if (headEl) headEl.innerText = heading ? `${heading.toFixed(0)}°` : '--';

                    if (isRecording) {
                        if (!startPoint) startPoint = currentPoint;
                        const overall = calculateBearing(startPoint.lat, startPoint.lng, latitude, longitude);
                        
                        const overallDirEl = document.getElementById('overall-direction');
                        if (overallDirEl) overallDirEl.innerText = `Heading ${overall} Overall`;
                        
                        const dirTripEl = document.getElementById('dir-trip');
                        if (dirTripEl) dirTripEl.innerText = overall;

                        tripData.push({
                            ts: new Date().toISOString(),
                            lat: latitude, lng: longitude, alt: altVal,
                            spd: (speed || 0).toFixed(3),
                            ax: (rawSensors.accel.x - offsets.accel.x).toFixed(4),
                            ay: (rawSensors.accel.y - offsets.accel.y).toFixed(4),
                            az: (rawSensors.accel.z - offsets.accel.z).toFixed(4),
                            gr: (rawSensors.gyro.alpha - offsets.gyro.alpha).toFixed(2),
                            gp: (rawSensors.gyro.beta - offsets.gyro.beta).toFixed(2),
                            gy: (rawSensors.gyro.gamma - offsets.gyro.gamma).toFixed(2)
                        });
                    }
                }, null, { enableHighAccuracy: true });
            }
        }

        function calibrateSensors() {
            offsets.accel = { ...rawSensors.accel };
            offsets.gyro = { ...rawSensors.gyro };
        }

        function startTrip() {
            const currentHour = new Date().getHours();
            if (currentHour >= 18 || currentHour < 6) document.body.classList.add('dashboard-night');
            
            isRecording = true;
            tripData = [];
            startPoint = currentPoint;
            
            const appBody = document.getElementById('app-body');
            if (appBody) appBody.classList.add('is-tracking');
            
            const overallDirEl = document.getElementById('overall-direction');
            if (overallDirEl) overallDirEl.innerText = "CALIBRATING JOURNEY...";
        }

        function stopTrip() {
            isRecording = false;
            document.body.classList.remove('dashboard-night');
            
            const appBody = document.getElementById('app-body');
            if (appBody) appBody.classList.remove('is-tracking');
            
            const overallDirEl = document.getElementById('overall-direction');
            if (overallDirEl) overallDirEl.innerText = "Trip Data Secured.";
            
            if (tripData.length > 0) {
                const trip = { id: Date.now(), date: new Date().toLocaleString(), data: tripData, start: startPoint };
                tripsHistory.unshift(trip);
                localStorage.setItem('transitlk_trips', JSON.stringify(tripsHistory));
            }
            updateTripList();
        }

        function updateTripList() {
            const list = document.getElementById('trip-list');
            if (!list) return;
            
            if (tripsHistory.length === 0) {
                list.innerHTML = `<div class="glass p-16 text-center opacity-30 text-[10px] font-black uppercase tracking-widest">No Trips Saved</div>`;
            } else {
                list.innerHTML = tripsHistory.map(t => `
                    <div onclick="viewTrip(${t.id})" class="glass p-5 flex justify-between items-center active:scale-[0.98]">
                        <div class="flex items-center gap-5">
                            <div class="w-12 h-12 rounded-2xl bg-white/5 flex items-center justify-center dynamic-accent-text"><i data-lucide="file-text" size="20"></i></div>
                            <div><p class="text-[11px] font-black uppercase">${t.date}</p><p class="text-[9px] opacity-40 uppercase font-black tracking-widest mt-0.5">${t.data.length} frames</p></div>
                        </div>
                        <i data-lucide="chevron-right" size="16" class="opacity-20"></i>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        let map;
        function viewTrip(id) {
            const trip = tripsHistory.find(t => t.id === id);
            activeTripId = id;
            
            const modal = document.getElementById('trip-modal');
            if (modal) modal.classList.remove('hidden');
            
            const modalTitle = document.getElementById('modal-title');
            if (modalTitle) modalTitle.innerText = `Trip: ${trip.date}`;

            const headers = "time,lat,lng,alt,spd,ax,ay,az,gr,gp,gy";
            const rows = trip.data.map(d => Object.values(d).join(",")).join("\n");
            
            const previewEl = document.getElementById('csv-preview');
            if (previewEl) previewEl.innerText = headers + "\n" + rows;
            
            if (map) map.remove();
            map = L.map('map', { zoomControl: false }).setView([trip.start.lat, trip.start.lng], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            const latlngs = trip.data.map(d => [d.lat, d.lng]);
            L.polyline(latlngs, {color: '#96d46c', weight: 5}).addTo(map);
            map.fitBounds(L.polyline(latlngs).getBounds(), { padding: [30, 30] });
            lucide.createIcons();
        }

        function closeModal() { 
            const modal = document.getElementById('trip-modal');
            if (modal) modal.classList.add('hidden'); 
        }
        
        function deleteTrip() {
            if (confirm("Delete permanently?")) {
                tripsHistory = tripsHistory.filter(t => t.id !== activeTripId);
                localStorage.setItem('transitlk_trips', JSON.stringify(tripsHistory));
                closeModal();
                updateTripList();
            }
        }
        
        function downloadCSV() {
            const trip = tripsHistory.find(t => t.id === activeTripId);
            const headers = "timestamp,lat,lng,altitude,speed_mps,ax,ay,az,gr,gp,gy\n";
            const rows = trip.data.map(d => Object.values(d).join(",")).join("\n");
            const blob = new Blob([headers + rows], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = window.URL.createObjectURL(blob);
            a.download = `TransitLK_${trip.id}.csv`;
            a.click();
        }
    </script>
</body>
</html>
